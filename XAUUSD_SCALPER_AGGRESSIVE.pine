// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// Â© XAUUSD Aggressive Scalper - High Frequency Mean Reversion

//@version=5
strategy("XAUUSD Aggressive Scalper [1-5M]", shorttitle="Aggressive Scalper", overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.05, slippage=3, calc_on_every_tick=true)

// ===========================================================================
// STRATEGY CONCEPT
// ===========================================================================
// Simple mean reversion scalper using Bollinger Bands + RSI
// - Buy when oversold at lower BB
// - Sell when overbought at upper BB
// - Quick scalps with tight SL and reasonable TP
// - High frequency (100+ trades target)

// ===========================================================================
// INPUT PARAMETERS
// ===========================================================================

// Bollinger Bands
bbLength = input.int(20, "BB Length", minval=1, group="Bollinger Bands")
bbStdDev = input.float(2.0, "BB Std Dev", minval=0.5, step=0.5, group="Bollinger Bands")

// RSI
rsiLength = input.int(14, "RSI Length", minval=1, group="RSI")
rsiOverbought = input.int(70, "RSI Overbought", minval=60, maxval=90, group="RSI")
rsiOversold = input.int(30, "RSI Oversold", minval=10, maxval=40, group="RSI")

// Risk Management
atrLength = input.int(14, "ATR Length", minval=1, group="Risk Management")
slMultiplier = input.float(1.0, "Stop Loss (x ATR)", minval=0.5, step=0.1, group="Risk Management")
tpMultiplier = input.float(2.0, "Take Profit (x ATR)", minval=0.5, step=0.5, group="Risk Management")

// Trend Filter
emaLength = input.int(50, "EMA Trend Filter", minval=10, group="Trend Filter")
useTrendFilter = input.bool(false, "Use EMA Trend Filter", tooltip="Only long above EMA, short below", group="Trend Filter")

// ===========================================================================
// CALCULATIONS
// ===========================================================================

// Bollinger Bands
[bbMiddle, bbUpper, bbLower] = ta.bb(close, bbLength, bbStdDev)

// RSI
rsi = ta.rsi(close, rsiLength)

// ATR
atrValue = ta.atr(atrLength)

// EMA
ema = ta.ema(close, emaLength)

// ===========================================================================
// ENTRY LOGIC
// ===========================================================================

// Price touching bands
atLowerBB = low <= bbLower
atUpperBB = high >= bbUpper

// RSI conditions
rsiOversoldCondition = rsi < rsiOversold
rsiOverboughtCondition = rsi > rsiOverbought

// Trend filter
aboveEMA = close > ema
belowEMA = close < ema
trendLongOK = not useTrendFilter or aboveEMA
trendShortOK = not useTrendFilter or belowEMA

// Entry conditions
longCondition = atLowerBB and rsiOversoldCondition and trendLongOK
shortCondition = atUpperBB and rsiOverboughtCondition and trendShortOK

// ===========================================================================
// RISK MANAGEMENT
// ===========================================================================

longSL = close - (atrValue * slMultiplier)
longTP = close + (atrValue * tpMultiplier)
shortSL = close + (atrValue * slMultiplier)
shortTP = close - (atrValue * tpMultiplier)

// ===========================================================================
// STRATEGY EXECUTION
// ===========================================================================

if longCondition
    strategy.entry("Long", strategy.long)
    strategy.exit("Exit Long", "Long", stop=longSL, limit=longTP)

if shortCondition
    strategy.entry("Short", strategy.short)
    strategy.exit("Exit Short", "Short", stop=shortSL, limit=shortTP)

// ===========================================================================
// VISUALS
// ===========================================================================

// Bollinger Bands
plot(bbMiddle, "BB Middle", color=color.new(color.blue, 0), linewidth=1)
plot(bbUpper, "BB Upper", color=color.new(color.red, 50), linewidth=1)
plot(bbLower, "BB Lower", color=color.new(color.green, 50), linewidth=1)
fill(plot(bbUpper), plot(bbLower), color=color.new(color.blue, 95))

// EMA
plot(useTrendFilter ? ema : na, "EMA", color=color.new(color.orange, 0), linewidth=2)

// Signals
plotshape(longCondition, "Long", shape.triangleup, location.belowbar, color.new(color.lime, 0), size=size.small)
plotshape(shortCondition, "Short", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

// ===========================================================================
// DASHBOARD
// ===========================================================================

var table dash = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 85), border_width=1)

if barstate.islast
    winRate = strategy.closedtrades > 0 ? (strategy.wintrades / strategy.closedtrades) * 100 : 0
    profitFactor = strategy.grossloss > 0 ? strategy.grossprofit / strategy.grossloss : 0

    table.cell(dash, 0, 0, "Aggressive Scalper", text_color=color.white, bgcolor=color.new(color.blue, 70))
    table.merge_cells(dash, 0, 0, 1, 0)

    table.cell(dash, 0, 1, "Trades", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 1, str.tostring(strategy.closedtrades), text_color=color.white, text_size=size.small)

    table.cell(dash, 0, 2, "Win%", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 2, str.tostring(winRate, "#.#") + "%", text_color=winRate >= 50 ? color.lime : color.red, text_size=size.small)

    table.cell(dash, 0, 3, "PF", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 3, str.tostring(profitFactor, "#.##"), text_color=profitFactor >= 1.5 ? color.lime : color.orange, text_size=size.small)

    table.cell(dash, 0, 4, "Profit", text_color=color.gray, text_size=size.small)
    table.cell(dash, 1, 4, "$" + str.tostring(strategy.netprofit, "#.##"), text_color=strategy.netprofit > 0 ? color.lime : color.red, text_size=size.small)

    table.cell(dash, 0, 5, "RSI", text_color=color.gray, text_size=size.small)
    rsiCol = rsi > 70 ? color.red : rsi < 30 ? color.lime : color.white
    table.cell(dash, 1, 5, str.tostring(rsi, "#"), text_color=rsiCol, text_size=size.small)
